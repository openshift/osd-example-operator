apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: osde2e-test-task
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Testing
    tekton.dev/tags: osde2e,testing,e2e
    tekton.dev/displayName: "OSDE2E Test Task"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task runs osde2e tests and collects results for Tekton Results observability.
    It captures stdout logs, JUnit XML results, and test status for pipeline observability.

  params:
  - name: OSDE2E_CONFIGS
    type: string
    description: Configuration string for osde2e (e.g., "rosa,sts,int,ad-hoc-image")
  - name: TEST_IMAGE
    type: string
    description: The test image to run
  - name: IMAGE_TAG
    type: string
    description: Tag for the test image
    default: "latest"
  - name: OCM_CLIENT_ID
    type: string
    description: OCM client ID for authentication
    default: ""
  - name: OCM_CLIENT_SECRET
    type: string
    description: OCM client secret for authentication
    default: ""
  - name: AWS_ACCESS_KEY_ID
    type: string
    description: AWS access key ID
    default: ""
  - name: AWS_SECRET_ACCESS_KEY
    type: string
    description: AWS secret access key
    default: ""
  - name: CLOUD_PROVIDER_REGION
    type: string
    description: Cloud provider region
    default: "us-east-1"
  - name: LOG_BUCKET
    type: string
    description: S3 bucket for logs
    default: "osde2e-logs"
  - name: USE_EXISTING_CLUSTER
    type: string
    description: Whether to use existing cluster
    default: "TRUE"
  - name: CLUSTER_ID
    type: string
    description: OpenShift cluster ID to test against
    default: ""
  - name: CAD_PAGERDUTY_ROUTING_KEY
    type: string
    description: PagerDuty routing key for alerts
    default: ""

  results:
  - name: test-results
    description: JUnit XML test results
  - name: test-logs
    description: Test execution logs
  - name: test-status
    description: Overall test status (PASS/FAIL)
  - name: test-summary
    description: Test execution summary

  workspaces:
  - name: workspace
    description: Combined workspace for artifacts and shared data (Prow-compatible paths)

  steps:
  - name: setup-test-environment
    image: quay.io/redhat-services-prod/osde2e-cicada-tenant/osde2e:latest
    env:
    - name: HOME
      value: /tekton/home
    script: |
      #!/bin/bash
      set -euo pipefail

      echo "Setting up test environment..."

      # Define paths matching Prow structure within single workspace
      ARTIFACTS_DIR="$(workspaces.workspace.path)/artifacts"
      SHARED_DIR="$(workspaces.workspace.path)/shared"

      # Create directories matching Prow structure
      mkdir -p ${ARTIFACTS_DIR}/junit
      mkdir -p ${ARTIFACTS_DIR}/logs
      mkdir -p ${SHARED_DIR}

      echo "Workspace directories created (Prow-compatible)"

      # Verify directories exist and are writable
      echo "=== ARTIFACTS directory ==="
      ls -la ${ARTIFACTS_DIR}/
      echo "=== SHARED directory ==="
      ls -la ${SHARED_DIR}/

      # Log environment information
      echo "=== Test Environment Setup ===" | tee ${ARTIFACTS_DIR}/logs/setup.log
      echo "OSDE2E_CONFIGS: $(params.OSDE2E_CONFIGS)" | tee -a ${ARTIFACTS_DIR}/logs/setup.log
      echo "TEST_IMAGE: $(params.TEST_IMAGE):$(params.IMAGE_TAG)" | tee -a ${ARTIFACTS_DIR}/logs/setup.log
      echo "CLOUD_PROVIDER_REGION: $(params.CLOUD_PROVIDER_REGION)" | tee -a ${ARTIFACTS_DIR}/logs/setup.log
      echo "USE_EXISTING_CLUSTER: $(params.USE_EXISTING_CLUSTER)" | tee -a ${ARTIFACTS_DIR}/logs/setup.log
      echo "Setup completed successfully" | tee -a ${ARTIFACTS_DIR}/logs/setup.log

    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault

  - name: run-osde2e-tests
    image: quay.io/redhat-services-prod/osde2e-cicada-tenant/osde2e:latest
    script: |
      #!/bin/bash
      set -euo pipefail

      echo "Starting osde2e test execution..."

      # Define paths matching Prow structure
      ARTIFACTS_DIR="$(workspaces.workspace.path)/artifacts"

      # Set test start time
      TEST_START_TIME=$(date -Iseconds)
      echo "Test started at: $TEST_START_TIME" | tee ${ARTIFACTS_DIR}/logs/test-execution.log

      # Run osde2e tests with enhanced logging and result collection
      TEST_EXIT_CODE=0
      /osde2e test \
        --only-health-check-nodes \
        --skip-destroy-cluster \
        --skip-must-gather \
        --configs $(params.OSDE2E_CONFIGS) \
        2>&1 | tee ${ARTIFACTS_DIR}/logs/osde2e-full.log || TEST_EXIT_CODE=$?

      # Set test end time
      TEST_END_TIME=$(date -Iseconds)
      echo "Test completed at: $TEST_END_TIME" | tee -a ${ARTIFACTS_DIR}/logs/test-execution.log
      echo "Test exit code: $TEST_EXIT_CODE" | tee -a ${ARTIFACTS_DIR}/logs/test-execution.log

      # Determine test status
      if [ $TEST_EXIT_CODE -eq 0 ]; then
        echo "PASS" > $(results.test-status.path)
        echo "✅ All tests passed" | tee -a ${ARTIFACTS_DIR}/logs/test-execution.log
      else
        echo "FAIL" > $(results.test-status.path)
        echo "❌ Tests failed with exit code: $TEST_EXIT_CODE" | tee -a ${ARTIFACTS_DIR}/logs/test-execution.log
      fi

      # Create test summary
      echo "=== Test Execution Summary ===" > ${ARTIFACTS_DIR}/logs/summary.log
      echo "Start Time: $TEST_START_TIME" >> ${ARTIFACTS_DIR}/logs/summary.log
      echo "End Time: $TEST_END_TIME" >> ${ARTIFACTS_DIR}/logs/summary.log
      echo "Exit Code: $TEST_EXIT_CODE" >> ${ARTIFACTS_DIR}/logs/summary.log
      echo "Status: $(cat $(results.test-status.path))" >> ${ARTIFACTS_DIR}/logs/summary.log
      echo "Config: $(params.OSDE2E_CONFIGS)" >> ${ARTIFACTS_DIR}/logs/summary.log

      # Copy summary to result
      cp ${ARTIFACTS_DIR}/logs/summary.log $(results.test-summary.path)

      # Always exit 0 here to allow collect-test-results step to run
      # The actual test status is stored in test-status result
      echo "Test execution completed with exit code: $TEST_EXIT_CODE"
      exit 0

    env:
    # Set HOME to writable directory to avoid .docker permission warnings
    - name: HOME
      value: /tekton/home
    # Test configuration
    - name: AD_HOC_TEST_IMAGES
      value: "$(params.TEST_IMAGE):$(params.IMAGE_TAG)"
    - name: CLOUD_PROVIDER_REGION
      value: "$(params.CLOUD_PROVIDER_REGION)"
    - name: LOG_BUCKET
      value: "$(params.LOG_BUCKET)"
    - name: USE_EXISTING_CLUSTER
      value: "$(params.USE_EXISTING_CLUSTER)"
    - name: CLUSTER_ID
      value: "$(params.CLUSTER_ID)"
    - name: CAD_PAGERDUTY_ROUTING_KEY
      value: "$(params.CAD_PAGERDUTY_ROUTING_KEY)"
    # osde2e output configuration - use workspace subdirectories
    - name: ARTIFACTS
      value: "$(workspaces.workspace.path)/artifacts"
    - name: REPORT_DIR
      value: "$(workspaces.workspace.path)/artifacts"
    - name: SHARED_DIR
      value: "$(workspaces.workspace.path)/shared"
    # Credentials from Secret and Parameters (Secret takes precedence)
    - name: OCM_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: osde2e-credentials
          key: OCM_CLIENT_ID
          optional: true
    - name: OCM_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: osde2e-credentials
          key: OCM_CLIENT_SECRET
          optional: true
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: osde2e-credentials
          key: AWS_ACCESS_KEY_ID
          optional: true
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: osde2e-credentials
          key: AWS_SECRET_ACCESS_KEY
          optional: true
    # Fallback to parameters if secret is not available
    - name: OCM_CLIENT_ID_PARAM
      value: "$(params.OCM_CLIENT_ID)"
    - name: OCM_CLIENT_SECRET_PARAM
      value: "$(params.OCM_CLIENT_SECRET)"
    - name: AWS_ACCESS_KEY_ID_PARAM
      value: "$(params.AWS_ACCESS_KEY_ID)"
    - name: AWS_SECRET_ACCESS_KEY_PARAM
      value: "$(params.AWS_SECRET_ACCESS_KEY)"

    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault

  - name: collect-test-results
    image: quay.io/redhat-services-prod/osde2e-cicada-tenant/osde2e:latest
    env:
    - name: HOME
      value: /tekton/home
    script: |
      #!/bin/bash
      set -euo pipefail

      echo "Collecting and processing test results..."

      # Define paths matching Prow structure
      ARTIFACTS_DIR="$(workspaces.workspace.path)/artifacts"

      # Process JUnit XML results from ARTIFACTS directory
      JUNIT_FOUND=false

      # Check for JUnit XML in ARTIFACTS directory
      if [ -d "${ARTIFACTS_DIR}" ]; then
        echo "Searching for JUnit XML files in ARTIFACTS directory..."
        find ${ARTIFACTS_DIR} -name "*.xml" -type f > /tmp/junit_files.txt 2>/dev/null || true

        if [ -s /tmp/junit_files.txt ]; then
          echo "Found JUnit XML files"
          JUNIT_COUNT=$(cat /tmp/junit_files.txt | wc -l)

          # Merge full results to workspace (not to Result)
          cat $(cat /tmp/junit_files.txt) > ${ARTIFACTS_DIR}/junit/merged-results.xml 2>/dev/null && JUNIT_FOUND=true

          # Store only summary in Result (to avoid size limit)
          echo "JUnit: Found $JUNIT_COUNT XML file(s)" > $(results.test-results.path)

          # Log JUnit summary
          echo "=== JUnit Results Summary ===" >> ${ARTIFACTS_DIR}/logs/summary.log
          echo "JUnit XML files found: $JUNIT_COUNT" >> ${ARTIFACTS_DIR}/logs/summary.log
          cat /tmp/junit_files.txt >> ${ARTIFACTS_DIR}/logs/summary.log
        fi
      fi

      # Also check for junit.xml in the main ARTIFACTS directory (common osde2e pattern)
      if [ -f "${ARTIFACTS_DIR}/junit.xml" ]; then
        echo "Found junit.xml in ARTIFACTS directory"
        cp ${ARTIFACTS_DIR}/junit.xml ${ARTIFACTS_DIR}/junit/junit.xml
        echo "JUnit: artifacts/junit.xml" > $(results.test-results.path)
        JUNIT_FOUND=true
      fi

      # If no JUnit results found, create minimal result
      if [ "$JUNIT_FOUND" = "false" ]; then
        echo "No JUnit XML results found"
        echo "JUnit: No results" > $(results.test-results.path)
        echo "No JUnit XML files found" >> ${ARTIFACTS_DIR}/logs/summary.log
      fi

      # Consolidate all logs to workspace
      echo "Consolidating test logs..."
      {
        echo "=== OSDE2E Test Execution Logs ==="
        echo "Generated at: $(date -Iseconds)"
        echo ""

        if [ -f "${ARTIFACTS_DIR}/logs/setup.log" ]; then
          echo "=== Setup Logs ==="
          cat ${ARTIFACTS_DIR}/logs/setup.log
          echo ""
        fi

        if [ -f "${ARTIFACTS_DIR}/logs/test-execution.log" ]; then
          echo "=== Test Execution Summary ==="
          cat ${ARTIFACTS_DIR}/logs/test-execution.log
          echo ""
        fi

        if [ -f "${ARTIFACTS_DIR}/logs/osde2e-full.log" ]; then
          echo "=== Full OSDE2E Output ==="
          cat ${ARTIFACTS_DIR}/logs/osde2e-full.log
        fi

        # Include osde2e generated logs from ARTIFACTS directory
        echo ""
        echo "=== OSDE2E Generated Files ==="
        find ${ARTIFACTS_DIR} -type f -name "*.log" 2>/dev/null | while read logfile; do
          if [ -f "$logfile" ]; then
            echo ""
            echo "=== $(basename $logfile) ==="
            cat "$logfile" 2>/dev/null || echo "Could not read $logfile"
          fi
        done

        # Include test_output.log if it exists (osde2e default)
        if [ -f "${ARTIFACTS_DIR}/test_output.log" ]; then
          echo ""
          echo "=== OSDE2E Test Output Log ==="
          cat ${ARTIFACTS_DIR}/test_output.log
        fi
      } > ${ARTIFACTS_DIR}/logs/consolidated.log

      # Store only summary in Result (to avoid 4KB limit)
      echo "Logs consolidated at: $(date -Iseconds)" > $(results.test-logs.path)
      echo "Full logs available in workspace: artifacts/logs/consolidated.log" >> $(results.test-logs.path)

      echo "Test result collection completed successfully"

    securityContext:
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: RuntimeDefault
